# SPDX-FileCopyrightText: Contributors to the Fedora Project
#
# SPDX-License-Identifier: MIT

name: CI
on: [push, pull_request, workflow_dispatch]
jobs:
  ci:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    container: fedorapython/fedora-python-tox:latest
    steps:
      - uses: actions/checkout@v4

      - name: Mark the directory as safe for git
        run: git config --global --add safe.directory $PWD

      - name: Install RPM dependencies
        run: |
          dnf install -y krb5-devel libpq-devel gettext python-tox

      - name: execute tox
        run: tox -- -v

  deployment:
    if: github.ref_name == 'staging' || github.ref_name == 'stable'
    needs: ci
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
    concurrency:
      group: ${{ github.ref_name }}
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: echo "$RUNNER_CONTEXT"

      - uses: actions/checkout@v4

      - name: Create the configuration file
        run: |
          mkdir -p ~/.config/
          echo '{"servers": {"${{ vars.MAUBOT_URL }}": "${{ secrets.MAUBOT_TOKEN }}"}, "default_server": "${{ vars.MAUBOT_URL }}"}' > ~/.config/maubot-cli.json

      - name: Install maubot
        run: |
          sudo apt-get install jq
          MAUBOT_VERSION=$(curl -s -H "Authorization:Bearer ${{ secrets.MAUBOT_TOKEN }}" ${{ vars.MAUBOT_URL }}/_matrix/maubot/v1/version | jq -r .version)
          pip install maubot==${MAUBOT_VERSION}

      - name: Deploy to the maubot server
        run: |
          mbc build -u
